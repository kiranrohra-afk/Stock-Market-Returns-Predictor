---
title: "ST362 Final Project"
subtitle: "Kira, Gracie, Jamie, Samiyah" #
output: html_notebook
editor_options: 
  markdown: 
    wrap: 72
---

# Introduction

An ETF or Exchange- Traded Fund is an investment fund that lets you buy
a large basket of individual stocks or government and corporate bonds in
one purchase. Due to their low risks, investing money in an ETF is a
common choice for beginner investors who want exposure to the stock
market. Accurately predicting the fund return of an ETF can help
investors make informed decisions regarding what they should put their
money into. The goal of our final project is to find a model that
accurately predicts the 3 year fund return of an ETF as well as the
characteristics of an ETF with high returns. Our aim is that, if a
consumer has the following information on an ETF, they can choose
whether or not to buy a particular ETF based on its predicted return and
compare returns with other ETFs. We will be investigating the following
predictor variables in our study:

Size type: Whether the ETF is from a small, medium sized or large cap
company

Fund yield: income return on the investment in the ETF as a percentage,
typically includes dividends and interest earned by the assets held in
the ETF

Investment Type: Growth, Value or Blend are different investment
strategies of all the ETFs in this analysis. Growth focuses on companies
expected to grow significantly faster than the market, often reinvesting
profits rather than paying dividends. Value targets undervalued
companies with strong fundamentals, trading at lower price-to-earnings
ratios, and often providing dividends. Blend combines both growth and
value stocks, offering a diversified portfolio that balances potential
high returns with lower risk.

Fund Sharpe ratio 3 years: The 3-year Sharpe ratio evaluates a fund's
risk-adjusted performance over the past three years by comparing its
excess returns to the volatility of those returns. A high Sharpe ratio
indicates that the investment has delivered higher returns per unit of
risk, suggesting more efficient performance relative to the risk taken.
A low Sharpe ratio suggests that the investment has provided lower
returns relative to the risk taken, indicating less efficient
performance.

Fund Treynor ratio 3 years: The 3-year Treynor ratio measures a fund's
return above the risk-free rate per unit of market risk, indicating how
well it has compensated investors for taking on market risk over the
past three years. A high Treynor ratio indicates that a fund has
provided high returns relative to the amount of market risk it has taken
on, suggesting efficient performance in compensating investors for
market risk.

The Sharpe ratio measures return per unit of total risk (volatility),
while the Treynor ratio measures return per unit of market risk. The
Sharpe ratio evaluates the overall risk-adjusted performance, while the
Treynor ratio focuses on systematic risk relative to the market.

Price Book Ratio: The fund price-to-book ratio compares the market price
of a fund's shares to its book value per share, indicating how much
investors are willing to pay for each dollar of net assets.

Price Cashflow Ratio: The fund price-to-cash-flow ratio measures a
fund's market price per share relative to its cash flow per share,
indicating how much investors are willing to pay for each dollar of cash
generated by the fund.

5 Year Mean Annual Return: The 5-Year Mean Annual Return represents the
average annual percentage return of an investment over a 5-year period.

# Importing and Cleaning Dataset

```{r}
# Check if the 'corrplot' package is installed
if (!require(corrplot)) {
  # If not installed, install the package
  install.packages("corrplot")
  # Load the package
  library(corrplot)
} else {
  # If already installed, just load the package
  library(corrplot)
}

library(MASS)
library(corrgram)
library(corrplot)
library(leaps)
library(ISLR)
library(corrgram)
library(car)
library(glmnet)
options(scipen = 999)  # Disable scientific notation


```

```{r}
ETFS<-read.csv("ETFs.csv")
keep=c("avg_vol_3month","fund_yield","investment_type","size_type","fund_return_3years","fund_sharpe_ratio_3years","fund_treynor_ratio_3years","fund_price_book_ratio","fund_price_cashflow_ratio","fund_mean_annual_return_5years") #columsn that we're keeping
ETF<-ETFS[keep]
ETF #new dataset

```

```{r}
#cleaning dataset, removing nas and ""s
ETF<-na.omit(ETF)
ETF <- subset(ETF, investment_type %in% c("Blend","Growth","Value")&size_type %in% c("Large","Medium","Small"))
ETF
```

```{r}

```

# Quantitative Variables

In this section, we investigate the quantitative variables to be
included in our final model as well as any issues with multicollinearity

```{r, warning=FALSE}
quant_vars <- ETF[sapply(ETF, is.numeric)]
corrgram(quant_vars,upper.panel = panel.cor,main = "Correlation Matrix of ETFs")

```

The correlation matrix shows quantitative variables with high
correlation with the fund return, which we can use as our predictors.
Based on this correlation matrix, the relevant predictors in relation to
the fund return seem to be the Sharpe ratio, the price-book ratio, the
price cashflow ratio, and perhaps the fund yield. There do seem to be
some potential issues with multicollinearity if we include all these
predictiors, as the price-cashflow ratio and the price-book ratio are
highly correlated, and they are both correlated to the sharpe ratio as
well. We will investigate these multicollinearity issues later using
variance inflation factors and experimenting with models.

# Categorical Variables

In this section, we investigate the categorical variables to include in
our final model.

```{r}
# make a boxplot of investment type and 3 year fund return
boxplot(fund_return_3years ~ investment_type, data = ETF,
        main = "Boxplot of 3 Year Fund Return by Investment type",
        xlab = "Investment Type", ylab = "3 Year Fund Return",
        ylim=c(-0.6,0.7))

```

It does look like there is a difference in the mean returns of different
investment types, especially Growth. This could be included as a dummy
variable and we can investigate potential interactions.

Lets look for some possible interactions with investment type

```{r}
library(ggplot2)


lmsharpratio <- lm(fund_return_3years~fund_sharpe_ratio_3years, data=ETF)
ETF$preds<-predict(lmsharpratio)




ggplot(ETF) +
    theme_bw() +
    aes(x = fund_sharpe_ratio_3years, colour = investment_type) +
    geom_point(aes(y = fund_return_3years)) +
    geom_line(aes(y = preds))


```

Looks like there's no interaction between fund ratio and investment
type. All 3 investment types seem to have the same slope and intercept.
There may be some high-leverage points that are skewing the data so
let's try taking those out

how about investment type and annual fund yield?

```{r}
lmfundyield = lm(fund_return_3years~fund_yield, data=ETF)
ETF$preds<-predict(lmfundyield)

ggplot(ETF) +
    theme_bw() +
    aes(x = fund_yield, colour = investment_type) +
    geom_point(aes(y = fund_return_3years)) +
    geom_line(aes(y = preds))


#actually, lets work with the dummy variables
```

looks like there's no interaction term here either, they have the same
slope nd intercept

I think it's still worth including in the model

```{r}
# make a boxplot of size type and 3 year fund return
boxplot(fund_return_3years ~ size_type, data = ETF,
        main = "Boxplot of 3 Year Fund Return by Size type",
        xlab = "Size Type", ylab = "3 Year Fund Return",
        ylim=c(-0.7,0.7))

```

It doesn't look like the size type has a significant difference between
the mean of the fund returns, but we can still investigate this
predictor with further models.

```{r}
MODEL1<-lm(fund_return_3years~fund_sharpe_ratio_3years+fund_price_book_ratio+fund_yield+investment_type+size_type,data=ETF)
summary(MODEL1)
vif(MODEL1)
```

```{r}
anova(MODEL1)
```

```{r}
MODEL2<-lm(fund_return_3years~fund_sharpe_ratio_3years+fund_yield+investment_type+size_type,data=ETF)
summary(MODEL2)
vif(MODEL2)
```

```{r}
MODEL3<-lm(fund_return_3years~fund_price_book_ratio+fund_yield+investment_type,data=ETF)
vif(MODEL3)
summary(MODEL3)

```

```{r}
MODEL4<-lm(fund_return_3years~fund_sharpe_ratio_3years+fund_yield+investment_type+fund_mean_annual_return_5years,data=ETF)
summary(MODEL4)
vif(MODEL4)
```

Idea: Fund yield, fund_sharpe_ratio, fund mean annual have different
scales so maybe try standardizing their predictors

ESS Test by hand

```{r}
#start with the variable that has the highest correlation with 3year return from the correlation plot

lm1 = lm(fund_return_3years~fund_sharpe_ratio_3years, data=ETF)

summary(lm1)
```

both predictors seem to be significant

Now let's try adding in treynor ratio.

```{r}

lm2 = lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years, data=ETF)

summary(lm2)

```

It's also very significant and increases the multiple R squred value
Since these 2 ratios measure very similar things it's worth looking into
potential issues with multicollinearity. But the values might need
standardizing

```{r}
vif(lm2)
```

The VIF is below 5 so it doesn't seem like the multicollinearity is
worth looking into

Next, let's see if the addition of treynor ratio is significant by doing
an ESS test. (Do this by hand later)

```{r}
anova(lm1,lm2)
```

looking at the P values here, the addition of fund_treynor_ratio seems
to be significant so we'll keep it in the model.

Now let's try adding in mean_annual return because it's the next most
correlated variable with fund_return_3years. The

```{r}
lm3 = lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years, data=ETF)

summary(lm3)

```

```{r}
vif(lm3)

```

yeah idk what to make of that, lets just add in investment type and see
what it does to the overall model

```{r}
lm4 = lm(fund_return_3years~investment_type, data = ETF)

summary(lm4)
```

Let's change the order so that value is the reference value for the
intercept

actually I don't think there are any interaction terms with the
categorical variable, so I'm just gonna add it in the model

```{r}
lm4 = lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years + investment_type, data=ETF)
summary(lm4)

vif(lm4)
```

Let's see if the addition of investment_type is significant

```{r}
anova(lm3,lm4)

```

Looks like the addition of investment_type is significant

```{r}
lm5=lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years + investment_type+ fund_price_book_ratio, data=ETF)

summary(lm5)
vif(lm5)
```

```{r}
lm6=lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years + investment_type+ fund_price_book_ratio+fund_yield, data=ETF)

summary(lm6)
vif(lm6)
```

```{r}
lm7=lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years + investment_type+ fund_price_book_ratio+fund_yield + fund_price_cashflow_ratio, data=ETF)

summary(lm7)
vif(lm7)
```

```{r}
lm8=lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years + investment_type+ fund_price_book_ratio+fund_yield + fund_price_cashflow_ratio+fund_yield, data=ETF)

summary(lm8)
vif(lm8)
```

```{r}
ggplot(ETF, aes(x=fund_mean_annual_return_5years, y = fund_return_3years, col=investment_type))+geom_point()+geom_smooth(method = "lm", se = FALSE)
```

```{r}
ggplot(ETF, aes(x=fund_price_book_ratio, y = fund_return_3years, col=investment_type))+geom_point()+geom_smooth(method = "lm", se = FALSE)
```

```{r}

```

```{r}
lm9=lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years*investment_type + fund_price_book_ratio, data=ETF)

summary(lm9)
vif(lm9)

?vif
```

```{r}
?vif
```

```{r}
lm10=lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years:investment_type + fund_price_book_ratio +fund_yield, data=ETF)

summary(lm10)
vif(lm10)

lm11 = lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years:investment_type+fund_yield, data=ETF)


anova(lm11,lm10)
```

```{r}

lm12=lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years:investment_type + fund_price_book_ratio +fund_yield, data=ETF)

summary(lm12)
vif(lm10)

lm13 = lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years:investment_type + fund_price_book_ratio, data=ETF)


anova(lm12,lm13)
summary(lm13)
```

Book ratio is not significant and neither are its interactions
fund_yield is significant

```{r}
lm14 = lm(fund_return_3years~fund_sharpe_ratio_3years + fund_treynor_ratio_3years + fund_mean_annual_return_5years:investment_type + fund_yield:investment_type, data=ETF)


summary(lm14)
```

looks like blend is very significant, lets try dummy encoding to include
it in the model

```{r}
plot(lm14)
```

## Fit a model by hand

```{r}
ETF[c("investment_type")]=lapply(ETF[c("investment_type")],factor)
#Dummy encode investment_type
contrasts(ETF$investment_type)
X = as.matrix(cbind(1, ETF$fund_sharpe_ratio_3years, ETF$fund_yield, ETF$investment_type, ETF$fund_mean_annual_return_5years))
Y = as.matrix((ETF$fund_return_3years))
beta = (solve(t(X)%*%X))%*%t(X)%*%Y
model_by_hand = X%*%beta
```

#Transformations Some of the transformations we tried included: - Adding
the square of both the sharpe ratios and treynor ratio, which resulted
in the sharpe ratio squared and sharpe ratio becoming insignificant, so
it was removed, and the addition of the treynor ratio cubed was very
significant, and raised the adjusted R-squared to 0.849 - We tried
adding the square of the mean annual return, but this was also
insignificant - We cannot do the log transformation of the original
response because our model is meant to predict negative values as well,
and our response included negative values. Applying a Log transformation
to this results in NaNs where the data is negative, and omits them when
creating the model. Due to this, we will add a constant to the response
to make the values positive, and then subtract it after the model has
been fitted to shift the model back to the original scale - We seem to
have some non-constant variance and non-normality, but a log
transformation did not solve it, and decreased the adjusted R squared to
0.80. - A boxcox transformation also did not help much with non-constant
variance, but it did increase the the adjusted R squared to 0.8711. - A
sqrt transformation somewhat helped with non-constant variance and the
QQ plot, and the adjusted R squared was 0.8305.

```{r}
#Adding treynor ratio cubed to the model, removed sharpe ratio
ETF$treynor_ratio_cd<-(ETF$fund_treynor_ratio_3years)^3

lm15 = lm(fund_return_3years~ fund_treynor_ratio_3years + fund_mean_annual_return_5years:investment_type + fund_yield:investment_type +treynor_ratio_cd , data=ETF)

summary(lm15)
plot(lm15)
```

Log transformation

```{r}
constant <- abs(min(ETF$fund_return_3years)) + 1
ETF$fund_return_3years_log <- log(ETF$fund_return_3years + constant)


# Fit the model with the log-transformed response variable
lm_log <- lm(fund_return_3years_log ~ fund_treynor_ratio_3years + fund_mean_annual_return_5years:investment_type + fund_yield:investment_type + treynor_ratio_cd, data = ETF)

# Summary of the model
summary(lm_log)
plot(lm_log)
```

```{r}
fitted_lm_log <- fitted(lm_log)

# Transform back to original scale
predictions_original_scale <- exp(fitted_lm_log) - constant
```

```{r}
# find the minimum value of the response variable
min_return <- min(ETF$fund_return_3years)

# add a constant to make all values positive
ETF$fund_return_3years_pos <- ETF$fund_return_3years + abs(min_return) + 1

#Adding treynor ratio cubed to the model, removed sharpe ratio
ETF$treynor_ratio_cd<-(ETF$fund_treynor_ratio_3years)^3

lm16 = lm(fund_return_3years_pos~ fund_treynor_ratio_3years + fund_mean_annual_return_5years:investment_type + fund_yield:investment_type +treynor_ratio_cd , data=ETF)

```

BoxCox Transformation

```{r}
BC<-boxcox(lm16)
L<-BC$x[which.max(BC$y)]
L
ETF$boxcox<-((ETF$fund_return_3years_pos)^L-1)/L

lm17<-lm(boxcox~fund_treynor_ratio_3years + fund_mean_annual_return_5years:investment_type + fund_yield:investment_type +treynor_ratio_cd,data=ETF)
summary(lm17)
plot(lm17)
```

```{r}
# reverse Box-Cox transformation on fitted values
fitted_lm17 <- (fitted(lm17) * L + 1)^(1 / L)

# Subtract the initial constant added to the response variable
predictions_original_scale <- fitted_lm17 - (abs(min_return) + 1)

```

Square Root Transformation

```{r}
# add a constant to ensure all values are positive before transformation
constant <- abs(min(ETF$fund_return_3years)) + 1
ETF$fund_return_3years_sqrt <- sqrt(ETF$fund_return_3years + constant)

# fit the model with the transformed response variable
lm_sqrt <- lm(fund_return_3years_sqrt ~ fund_treynor_ratio_3years + fund_mean_annual_return_5years:investment_type +fund_yield:investment_type + treynor_ratio_cd, 
              data = ETF)

# Summary of the model
summary(lm_sqrt)
plot(lm_sqrt)
```

```{r}
# Get the fitted values from the square root-transformed model
fitted_lm_sqrt <- fitted(lm_sqrt)

# Transform back to original scale
predictions_original_scale <- (fitted_lm_sqrt)^2 - constant
```

## Modelling

```{r}
#Choosing the final model
summary(lm17)
plot(lm17)
```

We have chosen model 17, which has undergone the boxcox transformation
and contains the predictors fund_treynor_ratio_3years +
fund_mean_annual_return_5years:investment_type +
fund_yield:investment_type +treynor_ratio_cd. This model had the highest
adjusted r squared of all 19 models we tried, of 0.8711. Some of the
other model like square root transformation had a better Q-Q plot, but
it wasn't a big enough difference to choose it over model 17 since it
had an adjusted R squared score of 0.8304. Along with the r\^2 value,
almost all of the predictors were very significant.

Final Model Parameter Interpretation

fund_treynor_ratio_3years: This measures how much excess return you earn
per unit of risk taken (specifically market risk, measured by beta) over
a 3-year period. In terms of ETFs, this tells you how effectively a fund
is performing relative to the market risk it is exposed to. A higher
ratio indicates better risk-adjusted performance.

fund_mean_annual_return_5years:investment_type: This interaction term
shows that the mean annual return over 5 years is being analyzed across
different investment types (Growth, Value, Blend). This can reveal
whether certain investment strategies (like Growth or Value)
consistently offer better returns over a 5-year period. The helps in
determining if the type of investment modifies the relationship between
annual returns.

fund_yield:investment_type: This interaction shows how the yield (income
return as a percentage of the investment) varies with investment type.
For example, Value ETFs might offer higher yields due to their focus on
dividends, while Growth ETFs may offer lower yields as they reinvest
earnings.

treynor_ratio_cd: This parameter might look at adjusted Treynor Ratio,
possibly tailored for certain conditions or data points. It's useful to
compare this with the standard Treynor Ratio (fund_treynor_ratio_3years)
to see if specific conditions (like downside protection or conditional
settings) alter the risk-return relationship.

Limitations

1.  Model Complexity and Overfitting: Several models were tested with
    different combinations of predictors, including interaction terms
    and transformations. The complexity of these models, with multiple
    predictors and interaction terms, raises the risk of overfitting,
    where the model fits the training data too closely and performs
    poorly on unseen data. 

2.  Transformation Challenges: A log transformation could not be
    directly applied due to negative values in the data, which required
    adding a constant before the transformation and subtracting it
    afterward. Other transformations, like the Box-Cox transformation,
    were attempted, but these did not significantly improve the model.
    This can mean that the data might not be well-suited to standard
    transformation techniques.

3.  One of the limitations of the model is that the residuals are not entirely 
    normally distributed, which can lead to biased predictions. Additionally, 
    the presence of non-constant variance, or heteroscedasticity, suggests that 
    the error terms vary across different levels of the predictors, reducing the
    model's reliability.

Conclusion

In conclusion, the analysis conducted on ETF data gives valuable
insights into the factors that influence 3-year fund returns. This helps
in understanding the relationships between various financial ratios and
investment outcomes. By exploring different models and transformations,
this project shows how specific variables such as the price-cashflow
ratio, price-book ratio, and Sharpe ratio, contribute to fund
performance.

Our models equation is: Y = 0.6275005086
+ 0.0151312123 * fund_treynor_ratio_3years 
- 0.0000038608 * treynor_ratio_cd 
+ 0.1043328660 * (fund_mean_annual_return_5years*investment_typeBlend) 
+ 0.1433833868 * (fund_mean_annual_return_5years * investment_typeGrowth) 
+ 0.1161220977 * (fund_mean_annual_reutrn_5years * investment_typeValue) 
+ 1.6285512761 * (investment_typeBlend * fund_yield)
- 0.6586412228 * (investment_typeGrowth * fund_yield) 
+ 0.9935363962 * (investment_typeValue * fund_yield) + e

In the given model equation, the highest absolute value coefficient is 
1.6285512761. It is associated with the interaction term between investment_typeBlend and fund_yield. This means that the combination of these two variables has the most significant impact on predicting the fund's 3-year return. Specifically, for funds classified as "Blend," the yield of the fund strongly influences the predicted return, with a positive effect. This suggests that higher yields in Blend-type investments will increase the fund's expected return according to the model, making it the most influential factor in this equation

Ultimately, this project helped us gain significant understanding of ETF
performance, and how it can help investors and analysts to make more
informed decisions based on empirical evidence and the model's natural
constraints.
